name: Deploy
on:
  push:
    branches:
      - master
concurrency:
  group: deploy
permissions:
  contents: read
jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.super.fish
          username: robot$tetra+ci
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          push: true
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: |
            docker.super.fish/tetra/tetra:latest
            docker.super.fish/tetra/tetra:${{ github.sha }}

      - name: Authenticate with Kubernetes
        run: |
          echo "${{ secrets.K8S_CERTIFICATE_AUTHORITY }}" | base64 -d > ca.crt
          kubectl config set-cluster super-cluster --certificate-authority="ca.crt" --embed-certs --server=https://super.fish:6443
          kubectl config set-credentials ci --token="${{ secrets.K8S_SERVICE_ACCOUNT_TOKEN }}"
          kubectl config set-context --user ci --namespace tetra --cluster super-cluster super-cluster
          kubectl config use-context super-cluster

      - name: Deploy
        run: |
          echo "${{ secrets.K8S_SECRET_YAML }}" > k8s/secret.yaml
          kubectl apply -k k8s

      - name: Wait for deployment
        run: |
          kubectl rollout restart deploy tetra
          kubectl rollout status deploy tetra
